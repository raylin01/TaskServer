<!DOCTYPE html>
<html>
<head>
  <title>TaskServer - Logs - <%= scriptName %></title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <header>
    <h1>TaskServer</h1>
    <nav>
      <a href="/scripts">Scripts</a> |
      <a href="/add-script">Add Script</a> |
      <a href="/settings">Settings</a>
    </nav>
  </header>
  <main class="logs-page">
    <div class="logs-header">
      <h2>üìã Logs for <code><%= scriptName %></code></h2>
      <a href="/scripts" class="btn-secondary">‚Üê Back to Scripts</a>
    </div>

    <div class="logs-stats">
      <div class="stat-card">
        <div class="stat-label">Total Log Files</div>
        <div class="stat-value"><%= stats.count %></div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Size</div>
        <div class="stat-value"><%= stats.count > 0 ? logs.reduce((sum, l) => sum + l.size, 0) : 0 %> bytes</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Latest Log</div>
        <div class="stat-value"><%= stats.newest ? new Date(stats.newest.mtime).toLocaleString() : 'None' %></div>
      </div>
    </div>

    <div class="logs-controls">
      <button class="refresh-btn" onclick="refreshLogs()">
        <span class="icon">‚Üª</span> Refresh Now
      </button>
      <div class="auto-refresh-wrapper">
        <span class="toggle-label">Tail Mode</span>
        <label class="toggle-switch">
          <input type="checkbox" id="tailMode" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>
      <div class="auto-refresh-wrapper">
        <span class="toggle-label">Auto-refresh (5s)</span>
        <label class="toggle-switch">
          <input type="checkbox" id="autoRefresh" checked>
          <span class="toggle-slider"></span>
        </label>
      </div>
      <select id="logFilter" onchange="filterLogs()">
        <option value="all">All Logs</option>
        <option value="out">Output Only</option>
        <option value="error">Errors Only</option>
      </select>
    </div>

    <div class="logs-container">
      <div class="logs-sidebar">
        <h3>Log Files <span class="file-count">(<span id="fileCount"><%= logs.length %></span>)</span></h3>
        <div id="logList" class="log-list">
          <% if (logs.length === 0) { %>
            <div class="no-logs">No log files found</div>
          <% } else { %>
            <% logs.forEach(log => { %>
              <a href="/logs/<%= scriptName %>?file=<%= log.name %>" 
                 class="log-item <%= log.name === selectedLog ? 'active' : '' %>"
                 data-type="<%= log.name.includes('error') ? 'error' : 'out' %>">
                <div class="log-item-header">
                  <span class="log-icon <%= log.name.includes('error') ? 'error' : 'out' %>">
                    <%= log.name.includes('error') ? '‚úï' : '‚óã' %>
                  </span>
                  <span class="log-name"><%= log.name %></span>
                </div>
                <div class="log-item-meta">
                  <span class="log-size"><%= log.sizeFormatted %></span>
                  <span class="log-time"><%= new Date(log.mtime).toLocaleTimeString() %></span>
                </div>
              </a>
            <% }) %>
          <% } %>
        </div>
      </div>

      <div class="logs-content">
        <div class="log-viewer-header">
          <h3 id="currentLog"><%= selectedLog || 'Select a log file' %></h3>
          <div class="log-actions">
            <button onclick="downloadLog()" class="btn-action btn-download" title="Download Log">
              <span class="icon">‚áì</span>
            </button>
            <button onclick="deleteLog()" class="btn-action btn-delete" title="Delete Log">
              <span class="icon">‚úï</span>
            </button>
          </div>
        </div>
        <pre id="logContent" class="log-viewer"><%= logContent || 'No log content' %></pre>
      </div>
    </div>
  </main>
  <footer>
    <small>&copy; 2025 TaskServer</small>
  </footer>
  
  <script>
    const scriptName = '<%= scriptName %>';
    let currentFile = '<%= selectedLog %>';
    let refreshInterval = null;
    let tailMode = true;
    let loadedOffset = 0; // Lines loaded from end
    let isLoading = false;
    let hasMoreLogs = true;
    let totalLines = 0;
    
    const logViewer = document.getElementById('logContent');
    
    // Load initial chunk in tail mode
    function loadInitialLogs() {
      if (!currentFile) return;
      
      fetch(`/api/logs/${scriptName}/chunk?file=${currentFile}&offset=0&limit=500&fromEnd=true`)
        .then(res => res.json())
        .then(data => {
          logViewer.textContent = data.content;
          loadedOffset = data.loadedLines;
          totalLines = data.totalLines;
          hasMoreLogs = data.hasMore;
          
          if (tailMode) {
            scrollToBottom();
          }
        })
        .catch(err => console.error('Failed to load logs:', err));
    }
    
    // Load more logs when scrolling up
    function loadMoreLogs() {
      if (!currentFile || isLoading || !hasMoreLogs) return;
      
      isLoading = true;
      logViewer.classList.add('loading');
      const previousHeight = logViewer.scrollHeight;
      
      fetch(`/api/logs/${scriptName}/chunk?file=${currentFile}&offset=${loadedOffset}&limit=500&fromEnd=true`)
        .then(res => res.json())
        .then(data => {
          if (data.content) {
            // Prepend content
            logViewer.textContent = data.content + '\n' + logViewer.textContent;
            loadedOffset += data.loadedLines;
            hasMoreLogs = data.hasMore;
            
            // Maintain scroll position
            const newHeight = logViewer.scrollHeight;
            logViewer.scrollTop = newHeight - previousHeight;
          }
          isLoading = false;
          logViewer.classList.remove('loading');
        })
        .catch(err => {
          console.error('Failed to load more logs:', err);
          isLoading = false;
          logViewer.classList.remove('loading');
        });
    }
    
    function refreshLogs() {
      const urlParams = new URLSearchParams(window.location.search);
      const file = urlParams.get('file') || currentFile;
      
      if (tailMode && file) {
        // In tail mode, just append new content
        fetch(`/api/logs/${scriptName}/chunk?file=${file}&offset=0&limit=500&fromEnd=true`)
          .then(res => res.json())
          .then(data => {
            const wasAtBottom = isScrolledToBottom();
            logViewer.textContent = data.content;
            
            if (wasAtBottom) {
              scrollToBottom();
            }
          })
          .catch(err => console.error('Failed to refresh logs:', err));
      } else {
        // Full refresh
        fetch(`/api/logs/${scriptName}?file=${file}`)
          .then(res => res.json())
          .then(data => {
            logViewer.textContent = data.logContent;
            document.getElementById('currentLog').textContent = data.selectedLog;
            
            // Update log list
            const logList = document.getElementById('logList');
            logList.innerHTML = data.logs.map(log => {
              const isError = log.name.includes('error');
              return `<a href="/logs/${scriptName}?file=${log.name}" 
                         class="log-item ${log.name === data.selectedLog ? 'active' : ''}"
                         data-type="${isError ? 'error' : 'out'}">
                        <div class="log-item-header">
                          <span class="log-icon ${isError ? 'error' : 'out'}">${isError ? '‚úï' : '‚óã'}</span>
                          <span class="log-name">${log.name}</span>
                        </div>
                        <div class="log-item-meta">
                          <span class="log-size">${log.sizeFormatted}</span>
                          <span class="log-time">${new Date(log.mtime).toLocaleTimeString()}</span>
                        </div>
                      </a>`;
            }).join('');
            
            document.getElementById('fileCount').textContent = data.logs.length;
            currentFile = data.selectedLog;
            filterLogs(); // Reapply filter
          })
          .catch(err => console.error('Failed to refresh logs:', err));
      }
    }
    
    function scrollToBottom() {
      logViewer.scrollTop = logViewer.scrollHeight;
    }
    
    function isScrolledToBottom() {
      return logViewer.scrollHeight - logViewer.scrollTop <= logViewer.clientHeight + 50;
    }
    
    function filterLogs() {
      const filter = document.getElementById('logFilter').value;
      const items = document.querySelectorAll('.log-item');
      let visibleCount = 0;
      
      items.forEach(item => {
        const type = item.getAttribute('data-type');
        if (filter === 'all' || filter === type) {
          item.style.display = 'block';
          visibleCount++;
        } else {
          item.style.display = 'none';
        }
      });
      
      document.getElementById('fileCount').textContent = visibleCount;
    }
    
    function downloadLog() {
      if (!currentFile) {
        alert('No log file selected');
        return;
      }
      // Create a download link
      const link = document.createElement('a');
      link.href = `/api/logs/${scriptName}/download?file=${currentFile}`;
      link.download = currentFile;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
    
    function deleteLog() {
      if (!currentFile) {
        alert('No log file selected');
        return;
      }
      
      if (!confirm(`Are you sure you want to delete ${currentFile}?`)) {
        return;
      }
      
      fetch(`/api/logs/${scriptName}/delete?file=${currentFile}`, { method: 'DELETE' })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            alert('Log file deleted successfully');
            window.location.reload();
          } else {
            alert('Failed to delete log: ' + data.error);
          }
        })
        .catch(err => {
          alert('Error deleting log: ' + err.message);
        });
    }
    
    // Scroll detection for progressive loading
    logViewer.addEventListener('scroll', function() {
      if (logViewer.scrollTop < 100 && hasMoreLogs && !isLoading) {
        loadMoreLogs();
      }
    });
    
    // Tail mode toggle
    document.getElementById('tailMode').addEventListener('change', function(e) {
      tailMode = e.target.checked;
      
      if (tailMode) {
        // Reset and load in tail mode
        loadedOffset = 0;
        hasMoreLogs = true;
        loadInitialLogs();
      }
    });
    
    // Auto-refresh toggle
    document.getElementById('autoRefresh').addEventListener('change', function(e) {
      if (e.target.checked) {
        refreshInterval = setInterval(refreshLogs, 5000);
      } else {
        if (refreshInterval) {
          clearInterval(refreshInterval);
          refreshInterval = null;
        }
      }
    });
    
    // Initialize
    if (currentFile && tailMode) {
      loadInitialLogs();
    }
    
    // Start auto-refresh by default
    refreshInterval = setInterval(refreshLogs, 5000);
    
    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (refreshInterval) clearInterval(refreshInterval);
    });
  </script>
</body>
</html>
