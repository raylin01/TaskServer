<!DOCTYPE html>
<html>
<head>
  <title>TaskServer - Scripts</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <header>
    <h1>TaskServer</h1>
    <nav>
      <a href="/scripts">Scripts</a> |
      <a href="/add-script">Add Script</a> |
      <a href="/settings">Settings</a>
    </nav>
  </header>
  <main>
    <h2>Scripts</h2>
    <table>
      <thead>
        <tr>
          <th>Name</th><th>Type</th><th>Source</th><th>Schedule</th><th>Status</th><th>Actions</th><th>Logs</th>
        </tr>
      </thead>
      <tbody>
        <% scripts.forEach(script => { %>
          <tr>
            <td><strong><%= script.name %></strong></td>
            <td><span class="badge badge-<%= script.type %>"><%= script.type %></span></td>
            <td>
              <% if (script.command) { %>
                <span title="<%= script.command %>" style="font-family: monospace; font-size: 0.85em;">
                  ðŸ’» <%= script.command.length > 40 ? script.command.substring(0, 40) + '...' : script.command %>
                </span>
              <% } else { %>
                <span title="<%= script.path %>" style="font-family: monospace; font-size: 0.85em;">
                  ðŸ“„ <%= script.path %>
                </span>
              <% } %>
            </td>
            <td><%= script.schedule || '-' %></td>
            <td>
              <% if (script.type === 'cron') { %>
                <% const cronHistory = cronRunHistory[script.name]; %>
                <% const isSuspended = cronSuspended && cronSuspended[script.name]; %>
                <% if (isSuspended) { %>
                  <span class="status status-stopped">Suspended</span>
                <% } else if (cronHistory && cronHistory.lastRun) { %>
                  <span class="status status-cron">Last run: <%= new Date(cronHistory.lastRun).toLocaleString() %></span>
                <% } else { %>
                  <span class="status status-pending">Last run: None</span>
                <% } %>
              <% } else { %>
                <% const pm2proc = pm2list.find(p => p.name === script.name); %>
                <% if (script.stopped || !pm2proc) { %>
                  <span class="status status-stopped">Stopped</span>
                <% } else if (pm2proc) { %>
                  <span class="status status-<%= pm2proc.pm2_env.status %>"><%= pm2proc.pm2_env.status %></span>
                <% } %>
              <% } %>
            </td>
            <td class="actions">
              <% if (script.type === 'cron') { %>
                <% const isSuspended = cronSuspended && cronSuspended[script.name]; %>
                <% if (isSuspended) { %>
                  <form method="post" action="/resume-cron/<%= script.name %>" style="display:inline">
                    <button type="submit" class="btn-action btn-start" title="Resume">
                      <span class="icon">â–¶</span>
                    </button>
                  </form>
                <% } else { %>
                  <form method="post" action="/suspend-cron/<%= script.name %>" style="display:inline">
                    <button type="submit" class="btn-action btn-stop" title="Suspend">
                      <span class="icon">â– </span>
                    </button>
                  </form>
                <% } %>
              <% } else { %>
                <% const pm2proc = pm2list.find(p => p.name === script.name); %>
                <% const isStopped = script.stopped || !pm2proc || pm2proc.pm2_env.status === 'stopped'; %>
                <% if (isStopped) { %>
                  <form method="post" action="/start-script/<%= script.name %>" style="display:inline">
                    <button type="submit" class="btn-action btn-start" title="Start">
                      <span class="icon">â–¶</span>
                    </button>
                  </form>
                <% } else { %>
                  <form method="post" action="/stop-script/<%= script.name %>" style="display:inline">
                    <button type="submit" class="btn-action btn-stop" title="Stop">
                      <span class="icon">â– </span>
                    </button>
                  </form>
                <% } %>
                <form method="post" action="/restart-script/<%= script.name %>" style="display:inline">
                  <button type="submit" class="btn-action btn-restart" title="Restart">
                    <span class="icon">â†»</span>
                  </button>
                </form>
              <% } %>
              <a href="/edit-script/<%= script.name %>" class="btn-action btn-edit" title="Edit">
                <span class="icon">âœŽ</span>
              </a>
            </td>
            <td><a href="/logs/<%= script.name %>" class="btn-link">
              <span class="icon">â˜°</span> View Logs
            </a></td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </main>
  <footer>
    <small>&copy; 2025 TaskServer</small>
  </footer>
</body>
</html>
